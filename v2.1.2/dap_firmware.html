<!-- HTML header for doxygen 1.9.6-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>CMSIS-DAP: CMSIS-DAP Firmware</title>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="tabs.js"></script>
<script type="text/javascript" src="footer.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<script type="text/javascript" src="darkmode_toggle.js"></script>
<link href="extra_stylesheet.css" rel="stylesheet" type="text/css"/>
<link href="extra_navtree.css" rel="stylesheet" type="text/css"/>
<link href="extra_search.css" rel="stylesheet" type="text/css"/>
<link href="extra_tabs.css" rel="stylesheet" type="text/css"/>
<link href="version.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../version.js"></script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 55px;">
  <td id="projectlogo" style="padding: 1.5em;"><a href="https://www.keil.arm.com/cmsis" target="_blank"><img alt="Logo" src="cmsis_logo_white_small.png"/</a></td>
  <td style="padding-left: 1em; padding-bottom: 1em;padding-top: 1em;">
   <div id="projectname">CMSIS-DAP
   &#160;<span id="projectnumber"><script type="text/javascript">
     <!--
     writeHeader.call(this);
     writeVersionDropdown.call(this, "CMSIS-DAP");
     //-->
    </script>
   </span>
   </div>
   <div id="projectbrief">Interface Firmware for CoreSight Debug Access Port</div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <span id="MSearchSelect"                onmouseover="return searchBox.OnSearchSelectShow()"                onmouseout="return searchBox.OnSearchSelectHide()">&#160;</span>
          <input type="text" id="MSearchField" value="" placeholder="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
  <!--END !PROJECT_NAME-->
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<div id="CMSISnav" class="tabs1">
  <ul class="tablist">
    <script type="text/javascript">
      writeComponentTabs.call(this);
    </script>
  </ul>
</div>
<!-- Generated by Doxygen 1.9.6 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('dap_firmware.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">CMSIS-DAP Firmware </div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#dap_hw_reqs">Hardware requirements</a></li>
<li class="level1"><a href="#dap_fw_examples">Example implementations</a></li>
<li class="level1"><a href="#dap_fw_prj">Create firmware project</a></li>
<li class="level1"><a href="#dap_config_mcu">Selecting target processor</a></li>
<li class="level1"><a href="#dap_config_io">Configuring I/O ports and debug unit</a></li>
<li class="level1"><a href="#dap_usart_swo">Enabling SWO trace</a></li>
<li class="level1"><a href="#dap_usart_com">Enabling serial port</a></li>
<li class="level1"><a href="#dap_config_usb">Configuring USB peripheral</a><ul><li class="level2"><a href="#dap_bulk_usb">Communication via USB bulk endpoints</a></li>
<li class="level2"><a href="#dap_usb_cdc">Communication Device Class</a></li>
</ul>
</li>
<li class="level1"><a href="#dap_config_flash">Programming into debug unit</a></li>
</ul>
</div>
<div class="textblock"><p><a class="anchor" id="md_src_dap_firmware"></a></p>
<p>The CMSIS-DAP firmware implements the <a class="el" href="index.html#mainpage">CMSIS-DAP concept</a>. The firmware is provided in a source code in <a href="https://github.com/ARM-software/CMSIS-DAP"><b>CMSIS-DAP GitHub repository</b></a> with several reference implementations for popular debug units. The table below explains the directory structure.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadLeft">Folders and Files   </th><th class="markdownTableHeadLeft">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">ðŸ“‚ Firmware   </td><td class="markdownTableBodyLeft">Folder with CMSIS-DAP Firmware.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft">â”£ ðŸ“„ Config/DAP_config.h   </td><td class="markdownTableBodyLeft">CMSIS-DAP firmware configuration file. See <a class="el" href="dap_firmware.html#dap_config_io">Configuring I/O ports and debug unit</a>.    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">â”£ ðŸ“‚ Examples   </td><td class="markdownTableBodyLeft">CMSIS-DAP firmware adapted to various debug units. See <a class="el" href="dap_firmware.html#dap_fw_examples">Example implementations</a>.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft">â”£ ðŸ“‚ Include   </td><td class="markdownTableBodyLeft">CMSIS-DAP firmware header file.    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">â”£ ðŸ“‚ Source   </td><td class="markdownTableBodyLeft">CMSIS-DAP firmware source code.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft">â”£ ðŸ“‚ Template   </td><td class="markdownTableBodyLeft">Interface templates for Keil MDK-Middleware.    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">â”— ðŸ“‚ Validation   </td><td class="markdownTableBodyLeft">Validation project. See <a class="el" href="dap_validate.html">Validate the debug unit operation</a>.   </td></tr>
</table>
<p>The implementation is composed of the following components:</p>
<ul>
<li>CMSIS-DAP firmware that interfaces to JTAG or SWD pins using standard I/O pins of the Cortex-M device.</li>
<li>CMSIS-Driver USART that connects:<ul>
<li>the UART of the Cortex-M device to the SWO output from the target.</li>
<li>an additional UART of the Cortex-M device to the UART from the target.</li>
</ul>
</li>
<li>USB stack that interfaces to the USB port of the host computer using:<ul>
<li>a custom class (for USB bulk endpoints),</li>
<li>the CDC ACM class to export USB COM Port.</li>
</ul>
</li>
<li>The USB Device middleware may require CMSIS-RTOS and a CMSIS-Driver USB.</li>
</ul>
<h1><a class="anchor" id="dap_hw_reqs"></a>
Hardware requirements</h1>
<p>The CMSIS-DAP firmware is designed for debug units that fulfill the following hardware requirements:</p>
<ul>
<li>Cortex-M processor-based microcontroller.</li>
<li>CPU Clock: 48 MHz or higher; microcontroller must have a SYSTICK timer.</li>
<li>RAM: 8 KB or more.</li>
<li>Flash ROM: 16 KB or more.</li>
<li>Full-speed or High-speed USB Device peripheral.</li>
<li>7 standard I/O pins for JTAG/SWD interface.</li>
<li>Optionally, 2 I/O pins for status LEDs.</li>
<li>Optionally, a UART to support SWO capturing (Rx pin connected to SWO).</li>
<li>Optionally, a UART to support an additional UART communication port (for printf debugging).</li>
</ul>
<p>The figure below illustrates the hardware interfaces of a CMSIS-DAP debug adapter.</p>
<div class="image">
<img src="CMSIS_DAP_Debug_Unit.png" alt=""/>
<div class="caption">
CMSIS-DAP debug unit Hardware</div></div>
    <h1><a class="anchor" id="dap_fw_examples"></a>
Example implementations</h1>
<p>Reference implementations of CMSIS-DAP firmware are provided as source code with complete project files and may be used as a starting point for the firmware adapatation to a new debug unit. Following examples are provided:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadLeft">Folders and Files   </th><th class="markdownTableHeadLeft">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">ðŸ“‚ Firmware/Examples   </td><td class="markdownTableBodyLeft">Folder with example CMSIS-DAP firmware projects.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft">â”£ ðŸ“‚ LPC-Link2   </td><td class="markdownTableBodyLeft">CMSIS-DAP firmware adapted to the NXP LPC-Link2 debug unit.    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">â”— ðŸ“‚ MCU-LINK   </td><td class="markdownTableBodyLeft">CMSIS-DAP firmware adapted to the NXP MCU-LINK debug unit.   </td></tr>
</table>
<p>In these examples the Keil MDK-Middleware USB stack is used. However, it is possible to use alternative USB stacks as well.</p>
<h1><a class="anchor" id="dap_fw_prj"></a>
Create firmware project</h1>
<p>To create CMSIS-DAP firmware that can be used on a different debug unit copy an existing firmware adaptation to a new folder. For example, copy the folder <code>Firmware/Examples/MCU-LINK</code> to a folder called <code>/Firmware/MyDebugUnit</code>.</p>
<p>Following steps describe the adaptation of the CMSIS-DAP firmware to a new debug unit:</p><ol type="1">
<li><a class="el" href="dap_firmware.html#dap_config_mcu">Selecting target processor</a> : Select the microcontroller and replace the CMSIS-Core (Cortex-M) files.</li>
<li><a class="el" href="dap_firmware.html#dap_config_io">Configuring I/O ports and debug unit</a> : Adapt the I/O ports and specify other parameters for the debug unit.</li>
<li><a class="el" href="dap_firmware.html#dap_usart_swo">Enabling SWO trace</a> : Optionally, you may add a CMSIS-Driver USART to interface to SWO.</li>
<li><a class="el" href="dap_firmware.html#dap_usart_com">Enabling serial port</a> : Optionally, you may add a CMSIS-Driver USART to interface to UART communication port.</li>
<li><a class="el" href="dap_firmware.html#dap_config_usb">Configuring USB peripheral</a> : Adapt the USB peripheral to the microcontroller.</li>
<li><a class="el" href="group__DAP__Vendor__gr.html">CMSIS-DAP Vendor Commands</a> : Optionally, you may add vendor specific commands to the debug unit.</li>
<li><a class="el" href="dap_firmware.html#dap_config_flash">Programming into debug unit</a> : Program the adapted firmware to the Flash ROM of the new debug unit.</li>
<li><a class="el" href="dap_validate.html">Validate the debug unit operation</a> : Validate the CMSIS-DAP firmware of the new debug unit.</li>
</ol>
<h1><a class="anchor" id="dap_config_mcu"></a>
Selecting target processor</h1>
<p>The CMSIS-DAP firmware is designed to execute on a debug unit that is using a Cortex-M processor-based microcontroller.</p>
<p>The following steps describe how to change the target microcontroller in the custom CMSIS-DAP firmware project:</p>
<ol type="1">
<li>In the ÂµVision IDE, open the project file <code>Firmware/MyDebugUnit/CMSIS_DAP.uvprojx</code>.</li>
<li>Open the <b>Project - Options - Device</b> dialog and select the microcontroller of the new debug unit.</li>
<li>Optionally, you may modify the project file <b>Target</b> name and the file <b>Abstract.txt</b> to reflect the new debug unit.</li>
</ol>
<div class="image">
<img src="MDK_Device.png" alt=""/>
<div class="caption">
Select the microcontroller</div></div>
    <p>In Keil MDK, changing the microcontroller adds relevant software components for the new target. However, depending on the availability you may need to replace some components with custom implementations.</p>
<div class="image">
<img src="RTE.png" alt=""/>
<div class="caption">
Replace missing software components</div></div>
    <h1><a class="anchor" id="dap_config_io"></a>
Configuring I/O ports and debug unit</h1>
<p>The CMSIS-DAP firmware configuration file <code>DAP_config.h</code> provides the interface functions and configuration parameters for the hardware of the CMSIS-DAP debug unit. Refer to <a class="el" href="group__DAP__ConfigIO__gr.html">CMSIS-DAP Firmware Configuration</a> for detailed descriptions of available configuration options.</p>
<h1><a class="anchor" id="dap_usart_swo"></a>
Enabling SWO trace</h1>
<p>Optionally, you may add a CMSIS-Driver USART to interface to SWO.</p>
<p>A CMSIS-Driver USART can be used to capture the trace output on the SWO pin using a UART RX input on the microcontroller. UART Serial Wire Output (SWO) trace can be enabled and configured in the header <code>DAP_config.h</code>. <a class="el" href="group__DAP__Config__Debug__gr.html#gaf0d60b30fb0eef2d249bc89a6e454ab6">SWO_UART</a> is used to enable the UART SWO and <a class="el" href="group__DAP__Config__Debug__gr.html#ga7a42055ea945d4b5433a6b458fa65b8a">SWO_UART_DRIVER</a> is used to configure USART Driver instance number (Driver_USART#).</p>
<p>Refer to <a class="el" href="group__DAP__Config__Debug__gr.html">CMSIS-DAP Debug Unit Information</a> for more information.</p>
<h1><a class="anchor" id="dap_usart_com"></a>
Enabling serial port</h1>
<p>Optionally, you may add a CMSIS-Driver USART to interface to UART communication port.</p>
<p>A CMSIS-Driver USART can be used to receive data from the target and transmit data to the target using UART RX and TX pins on the microcontroller. The UART communication port can be enabled and configured in the header <code>DAP_config.h</code>. <a class="el" href="group__DAP__Config__Debug__gr.html#gaadf03219973619f13487c3fcc0237256">DAP_UART</a> is used to enable the UART communication port and <a class="el" href="group__DAP__Config__Debug__gr.html#ga7afeb2572e74f9d14a9183f23b9e2779">DAP_UART_DRIVER</a> is used to configure USART Driver instance number (Driver_USART#).</p>
<p>Refer to <a class="el" href="group__DAP__Config__Debug__gr.html">CMSIS-DAP Debug Unit Information</a> for more information.</p>
<h1><a class="anchor" id="dap_config_usb"></a>
Configuring USB peripheral</h1>
<p>CMSIS-DAP firmware communicates via USB with the host computer. The USB communication is implemented via Keil MDK-Middleware components that access the USB peripheral of the microcontroller.</p>
<p>The CMSIS-DAP v2 firmware uses <a class="el" href="dap_firmware.html#dap_bulk_usb">USB bulk endpoints</a> that provide high-speed communication. In addition, <a class="el" href="dap_firmware.html#dap_usb_cdc">Communication Device Class</a> is used to enable USB COM port.</p>
<p>For the USB interface it is important to provide correct configuration information for the USB peripheral as described in this section.</p>
<p>The following steps describe how to change and configure the USB peripheral in the CMSIS-DAP firmware project:</p>
<ol type="1">
<li>In the <b>Project Window</b>, the group <b>USB</b> contains USB interface with the relevant configuration files.</li>
<li>Open the file <code>usb_config_0.c</code> in the editor and select <b>Configuration Wizard</b> as edit mode; then change the following settings:<ul>
<li><b>USB Device 0 - High-speed</b>: enable this option only for a high-speed USB peripheral; disable for full-speed USB.</li>
<li>Update <b>Device Settings - Vendor ID</b> which is provided by the <a href="https://www.usb.org/getting-vendor-id">USB Implementers Forum</a>.</li>
<li>Update <b>Device Settings - Product ID</b> to provide a unique identification for the debug unit.</li>
<li>Update <b>Device Settings - Device Release Number</b> to indicate the revision of the adaptation.</li>
<li>Update <b>String Settings - Manufacturer String</b> to reflect the vendor of the debug unit. This setting should match the <b>Vendor ID</b>.</li>
<li>Update <b>String Settings - Product String</b> to indicate the debug unit. Note that "CMSIS-DAP" must be part of that string to allow identification by debuggers (or part of interface string for USB composite device).</li>
<li>Optionally each debug unit may provide a unique <b>Serial Number String</b>. If the <b>String Settings - Serial Number String</b> is not provided, only one debug unit can be connected at the same time to a host computer since it is impossible to identify multiple debug units.</li>
</ul>
</li>
</ol>
<blockquote class="doxtable">
<p>&zwj;<b>Note</b></p><ul>
<li>The USB Device setting high-speed / full-speed USB must be reflected in the <code>DAP_config.h</code> file.</li>
<li>The <b>String Settings - Product String</b> must contain "CMSIS-DAP" somewhere in the string. This is used by the debuggers to identify a CMSIS-DAP compliant debug unit that is connected to a host computer. </li>
</ul>
</blockquote>
<p><img src="MDK_USB.png" alt="" class="inline" title="Adapt the USB Peripheral to the microcontroller"/>    </p>
<h2><a class="anchor" id="dap_bulk_usb"></a>
Communication via USB bulk endpoints</h2>
<p>CMSIS-DAP v2 uses USB bulk endpoints. Optionally, support for streaming SWO trace is provided via an additional USB endpoint.</p>
<p>This configuration requires custom class support with the interface setting:</p>
<ul>
<li>Class Code: <code>0xFF</code> (Vendor specific)</li>
<li>Subclass: <code>0x00</code></li>
<li>Protocol code: <code>0x00</code></li>
</ul>
<blockquote class="doxtable">
<p>&zwj;<b>Note</b></p><ul>
<li>This interface enables also <a href="https://wicg.github.io/webusb/">WebUSB</a> technology that is used in web browsers to connect to a debug adapter connected to your PC. </li>
</ul>
</blockquote>
<p>Depending on the configuration, it uses the following USB endpoints which should be configured in the interface descriptor in this order:</p>
<ul>
<li>Endpoint 1: Bulk Out â€“ used for commands received from host PC.</li>
<li>Endpoint 2: Bulk In â€“ used for responses send to host PC.</li>
<li>Endpoint 3: Bulk In (optional) â€“ used for streaming SWO trace (if enabled with <a class="el" href="group__DAP__Config__Debug__gr.html#gafd6f450a10f4e03757388e00ea56906f">SWO_STREAM</a>).</li>
</ul>
<div class="image">
<img src="MDK_USB_Custom.png" alt=""/>
<div class="caption">
Configuration settings for the USB custom class</div></div>
    <blockquote class="doxtable">
<p>&zwj;<b>Note</b></p><ul>
<li>These settings allow support in Windows (8 and above), Mac OS, and Linux without further drivers. Some additional settings are required to automatically install CMSIS-DAP enabled debug adapters in these operating systems. </li>
</ul>
</blockquote>
<p><b>Additional settings for Microsoft Windows</b></p>
<p>For automatic installation of a CMSIS-DAP v2 enabled debug adapter in Windows, use the following WinUSB GUID in the USB custom class:</p>
<div class="fragment"><div class="line">{CDB3B5AD-293B-4663-AA36-1AAE46463776}</div>
</div><!-- fragment --><p>The picture below shows the WinUSB GIUD configuration of the USB custom class:</p>
<div class="image">
<img src="MDK_USB_Custom_WinUSBGIUD.png" alt=""/>
<div class="caption">
Adapt CMSIS-DAP to the WinUSB class</div></div>
    <p><a class="anchor" id="wininf"></a><b>USB Driver</b></p>
<p>Windows 8 and above does not require a WinUSB driver provided that the USB firmware stack supports Microsoft descriptors.</p>
<p>CMSIS-DAP v2 device should be configured as WCID (Windows Compatible ID) device which provides extra information to a Windows system to facilitate automated driver installation.</p>
<p>Also see <a class="el" href="dap_drv_install.html">Host OS Drivers</a> for additional information.</p>
<h2><a class="anchor" id="dap_usb_cdc"></a>
Communication Device Class</h2>
<p>CMSIS-DAP v2 supports also a UART communication port optionally routed to a USB COM port which is implemented by a USB Communication Device Class (CDC) device.</p>
<p>The picture below shows the configuration of the USB CDC class.</p>
<div class="image">
<img src="MDK_USB_CDC.png" alt=""/>
<div class="caption">
Configuration of USB CDC class</div></div>
    <h1><a class="anchor" id="dap_config_flash"></a>
Programming into debug unit</h1>
<p>Once the CMSIS-DAP firmware is configured and built, it needs to be programmed into the Flash ROM of the new debug unit.</p>
<p>Keil MDK provides Flash algorithms for many Cortex-M based microcontrollers and therefore you may use the Flash programming facilities that are provide in ÂµVision. Once Flash programming is configured, you may use the ÂµVision menu item <b>Flash - Download</b>.</p>
<div class="image">
<img src="MDK_Flash.png" alt=""/>
<div class="caption">
Download CMSIS-DAP firmware to new debug unit using MDK</div></div>
     </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">
      <script type="text/javascript">
        <!--
        writeFooter.call(this);
        //-->
      </script> 
    </li>
  </ul>
</div>
</body>
</html>
